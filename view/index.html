{{define "index"}}
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>ipfs</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="renderer" content="webkit" />
	<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
	<link rel="stylesheet" href="/asset/css/w3.css" />
	<link rel="stylesheet" href="/asset/css/css.css" />
	<script type="text/javascript" src="/asset/js/jquery1.9.1.min.js"></script>

</head>

<body id="app">
<div class="w3-panel w3-blue w3-card-4 mt0 p10">
	<p class="m0">peerid：{%peerid%}</p>
	<p class="el m0">pubkey：{%pubkey%}</p>
	<p class="m0">Recipient：{%recipient%}</p>
</div>

<div class="wrap mt20">
	<div class="row col-sp12">
		<div class="w4">
			<div class="w3-blue p5">ipnskeys</div>
			<ul class="w3-ul w3-border bk">
				<li><a href="javascript:;" class="w3-btn w3-red" onclick="dlg_new_ipnskey()">新增ipnskey</a></li>
				<li i-for="ipnskeyslist">
					{%item[0]%}:<a href="javascript:;" i-onclick="{%load_ipns(item[1])%}" class="clink">{%item[1]%}</a>
					&nbsp; <a i-onclick="{%rm_ipnskey(item[0])%}" href="javascript:;" class="clink">删除</a>
					&nbsp; <a i-if="{% $.inArray(item[1],followed_ns)<0 %}" i-onclick="{%follow(item[0],item[1])%}" href="javascript:;" class="clink">follow</a>
				</li>
			</ul>
			
			<div class="w3-blue p5 mt10">follows</div>
			<ul class="w3-ul w3-border bk">
				<li i-for="followslist">{%item.name%}:<a href="javascript:;" i-onclick="{%load_ipns(item.ns)%}" class="clink">{%item.ns%}</a>
				&nbsp; <a i-onclick="{%unfollow(item.ID)%}" href="javascript:;" class="clink">unfollow</a>
				</li>
			</ul>
			<div class="w3-blue p5 mt10">peers</div>
			<ul class="w3-ul w3-border bk">
				<li><a href="javascript:;" class="w3-btn w3-red" i-onclick="{%add_peers()%}">新增peers</a></li>
				<li i-for="peerslist">{%item.name%}</li>
			</ul>
			<div class="w3-blue p5 mt10">stream</div>
			<ul class="w3-ul w3-border bk" style="max-height:200px;overflow-y:scroll;overflow-y:auto;">
				<li>
					<label><input type="checkbox" class="w3-radio" value="1" i-checked="{%stream_on%}" i-onclick="switch_stream">set stream</label>
				</li>
				<li i-for="streamlist">{%item%}</li>
				<li>
					<form class="" onsubmit="return false;" i-onsubmit="newstream">
						<input class="w3-input w3-border" name="peerid" type="text" placeholder="peerid" required />
						<input class="w3-input w3-border" name="body" type="text" placeholder="内容" required />
						<button type="submit" class="w3-btn w3-tiny w3-blue">发送</button>
					</form>
				</li>
			</ul>
		</div>
		<div class="w8">
			<div class="w3-border">
				<div class="w3-container w3-blue"><h3>发表内容</h3></div>
				<form class="w3-container" id="publish_form" onsubmit="publish_content(this);return false;">
					<div class="w3-section">
						<label>ipfs ns：</label>
						<select name="nsname" class="w3-select">
							<option i-for="ipnskeyslist" value="{%item[0]%}">{%item[0]%}</option>
						</select>
					</div>
					<div class="w3-section">
						<label>发送目标：</label>
						<label><input type="radio" class="w3-radio" name="to0" value="@all" checked>所有人</label>
						<label><input type="radio" class="w3-radio" name="to0" value="@me" >仅自己可见</label>
						<input class="w3-input" name="to" type="text" placeholder="其它发送目标" />
					</div>
					<div class="w3-section">
						<label>内容类型：</label>
						<label><input type="radio" class="w3-radio" name="type" value="markdown">markdown</label>
						<label><input type="radio" class="w3-radio" name="type" value="html" checked>html</label>
					</div>
					<div class="w3-section">
						<label>内容：</label>
						<textarea class="w3-input" name="body"></textarea>
					</div>
					<div class="w3-section">
						<label>附件上传：</label>
						<input type="file" name="uploads" id="upfile" />
						<!--<input type="hidden" name="init" value="true" />-->
					</div>
					<div class="w3-section">
						<button type="submit" class="w3-btn w3-blue">发表内容</button>
					</div>
				</form>
			</div>

			<div class="w3-border mt10">
				<div class="w3-container w3-blue"><h3>内容</h3></div>
				<ul class="w3-ul bk">
					<li i-for="postlist">
						{%item.dt.body%}
						<p i-if="{%item.dt.attachments%}">{%item.dt.attachments%}</p>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>





</body>




<!-- The Modal -->
<div id="pwd_dialog" class="w3-modal">
	<div class="w3-modal-content pt35 pb25">
		<div class="w3-container">
			<span onclick="$('id01').hide()" class="w3-button w3-display-topright">&times;</span>
			<form class="w3-container" onsubmit="set_local_pwd(this);return false;">
				<p><label>Local Password</label>
				<input class="w3-input" type="password" name="password" /></p>
				<button type="submit" class="w3-btn w3-blue">Set Password</button>
			</form>
		</div>
	</div>
</div>


<div style="height:50px">&nbsp;</div>
<script type="text/javascript" src="/asset/layer/layer.js"></script>
<script type="text/javascript" src="/asset/js/iceView.js"></script>
<script type="text/javascript" src="/asset/js/fn.js"></script>
<script type="text/javascript">


var evtSource=null;
function list_follows(){
	evtSource = new EventSource('/listenfolloweds');
	/*evtSource.onmessage=function(event){
		console.log(event);
	}*/
	evtSource.addEventListener('message',function(e){
		console.log(e);
	});
	evtSource.onerror=function(error){
		console.log('错误msg',error);
		try{
			evtSource.close();
		}catch(e){
			evtSource=null;
		}
	}
	/*$.get('/listenfolloweds',function(res){
		if(res.code!='1'){return;}
		var htm=''
		$.each(res.data,function(k,v){
			htm+='<li>'+v[0]+': '+v[1]+'</li>'
		});
		$('#listenfolloweds').html(htm);
	},'json')*/
}

function set_local_pwd(f){
	var pwd=$.trim(f.password.value);
	if(!pwd){
		alerterr('password must not null!');return;
	}
	loading()
	$.post('/getsecretkey',{'password':pwd},function(res){
		hideload()
		if(res.code=='1'){
			sessionStorage.setItem('secretkey',res.data);
			$('#pwd_dialog').hide();
			init();
		}else{
			alerterr(res.data)
		}
	},'json');
}




var evtSc = null;
function open_stream(fn){
	if(evtSc) evtSc.close();
	evtSc = new EventSource('/setstream');
	evtSc.onmessage=function(e){
		fn(e.data)
		console.log(e)
	}
	evtSc.onerror=function(e){
		console.log(e)
	}
}
function close_stream(){
	if(evtSc){
		evtSc.close()
	}
	evtSc = null;
}


var iv=ice.view('#app',{
	followed_ns:[],
	postlist:[],
	error_ipns_list:[],
	p2p_on:[],
	getrecipient:function(){
		var zs=this;
		$.get('/getrecipient',null,null,'json').then(function(res){
			if(res['code']){
				zs.recipient=res.data;
				zs.getpubkey()
			}else{
				$('#pwd_dialog').show();
			}
		});
	},
	getpubkey:function(){
		var zs=this;
		$.get('/getpubkey',function(res){
			if(res['code']){
				zs.peerid=res['data']['peerid'];
				zs.pubkey=res['data']['pubkey'];
			}
			zs.load_all()
		},'json')
	},
	listipnskey:function(){
		var zs=this;
		$.ajax({
			url:'/listipnskey',
			timeout:3000,
			success:function(res){
				if(!res['code']){alerterr(res['data']);return}
				zs.ipnskeyslist=res['data'];
			}
		})
	},
	rm_ipnskey:function(nsname){
		var zs=this;
		layconfirm('是否要删除【'+nsname+'】？',function(){
			$.post('/reomveipnskey',{'nsname':nsname},function(res){
				if(!res['code']){alerterr(res['data']);return}
				zs.listipnskey();
			},'json');
		})
	},
	getfollows:function(){
		var zs=this;
		zs.followed_ns=[];
		$.get('/getfollows',function(res){
			if(!res['code']){alerterr(res['data']);return}
			$.each(res['data'],function(k,v){
				zs.followed_ns.push(v.ns)
			})
			zs.followslist=res['data']
		},'json')
	},
	follow:function(name,ns){
		var zs=this;
		$.post('/follow',{'name':name,'ns':ns},function(res){
			if(!res['code']){alerterr(res['data']);return}
			zs.getfollows();
		},'json');
	},
	unfollow:function(id){
		var zs=this;
		layconfirm('是否要取消关注？',function(){
			$.post('/unfollow',{'id':id},function(res){
				if(!res['code']){alerterr(res['data']);return}
				zs.getfollows();
				zs.listipnskey();
			},'json');
		})
	},
	getpeers:function(){
		var zs=this;
		$.get('/getpeers',function(res){
			if(!res['code']){alerterr(res['data']);return}
		},'json')
	},
	add_peers:function(){
		
	},
	load_all:function(){
		this.listipnskey();
		this.getfollows();
		this.getpeers();
	},
	load_ipns:function(url){
		if(!url) return;
		if(url.indexOf('/ipns/')<0) return;
		if(!end_with(url,'/')) url=url+'/';
		var zs=this;
		$.ajax({
			url:url,
			timeout:3000,
			success:function(res){
				if(!res['code']){alerterr(res['data']);return}
				zs.load_ipfs(res['data']['path']);
			},
			error:function(){
				zs.error_ipns_list.push(url);
				zs.error_ipns_list=$.unique(zs.error_ipns_list);
			}
		});
	},
	load_ipfs:function(url){
		if(!url) return;
		if(url.indexOf('/ipfs/')<0) return;
		if(!end_with(url,'/')) url=url+'/';
		//var nsk=ipns.replace(/\//g,'');
		var exist=0;
		$.each(this.postlist,function(k,v){
			if(v['url']==url){
				exist=1;return false;
			}
		});
		if(exist) return;
		var zs=this;
		$.get(url+'/post.json',function(res){
			zs.postlist.push({'url':url,'dt':res})
		},'json').then(function(){
			$.get(url+'/meta.json',function(res){
				if(res['next']){
					zs.load_ipfs(res['next']);
				}
			},'json')
		});
	},

	streamlist:[],
	stream_on:false,
	switch_stream:function(el){
		var zs=this;
		if(el.checked){
			zs.stream_on=true;
			open_stream(function(dt){
				zs.streamlist.push(dt)
			});
		}else{
			zs.stream_on=false;
			close_stream()
		}
	},
	newstream:function(el){
		if(!this.stream_on) return;
		var zs=this;
		var dt={'peerid':el.peerid.value,'body':el.body.value};
		$.post('/newstream',dt,function(res){
			
		})
	}
});
function dlg_new_ipnskey(){
	layinput('请输入ipnskey的nsname','',function(v){
		v=$.trim(v);
		if(!v){msgerr('未输入');return;}
		$.post('/newipnskey',{'nsname':v},function(res){
			if(!res['code']){alerterr(res['data']);return}
			iv.data.listipnskey()
		})
	})
}
function chk_ipns_init(nm,fn){
	var iurl=''
	$.each(iv.data.ipnskeyslist,function(k,v){
		if(v[0]==nm){
			iurl=v[1];return false;
		}
	});
	if(!iurl){fn(1)}
	$.ajax({
		url:iurl,
		timeout:3000,
		success:function(res){
			if(!res['code']){fn(0);return}
			fn(0)
		},
		error:function(){fn(1)}
	});
}
function publish_content(f){
	var iptfile=document.getElementById('upfile');
	var flen=iptfile.files.length;
	var formdata=new FormData(document.getElementById('publish_form'));
	if(flen<1){
		formdata.delete('uploads');
	}
	var to0=formdata.get('to0');
	if(to0=='@all'){
		formdata.delete('to');
	}else if(to0=='@me'){
		formdata.set('to','')
	}
	formdata.delete('to0');
	loading();
	chk_ipns_init(formdata.get('nsname'),function(need_init){
		if(need_init){
			formdata.append('init','true');
		}
		$.ajax({
			url:'/publish',
			type:"POST",
			data:formdata,
			dataType:'json',
			processData:false,
			contentType:false,
			error:function(){hideload();alerterr('发布失败');},
			success:function(res){
				hideload()
				if(res.code=='1'){
					alertok('发布成功!');
					iv.data.listipnskey();
					f.reset()
				}else{
					alerterr(res.data)
				}
			}
		})
	})
	
}
function init(){
	iv.data.getrecipient();
}

$(function(){
	init();
})



</script>
</html>
{{end}}